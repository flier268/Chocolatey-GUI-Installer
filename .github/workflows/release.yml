name: Build and Release

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag (e.g., v1.0.0)'
        required: true
        type: string
      pre_release:
        description: 'Mark as pre-release'
        required: false
        default: false
        type: boolean
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Install ps2exe module
        shell: pwsh
        run: |
          Set-PSRepository -Name 'PSGallery' -InstallationPolicy Trusted
          Install-Module -Name ps2exe -Force -Scope CurrentUser -AllowClobber
          Import-Module ps2exe
          Get-Command ps2exe
        
      - name: Create directories
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path "build" -Force
          New-Item -ItemType Directory -Path "scripts-only" -Force
          New-Item -ItemType Directory -Path "executables-only" -Force
        
      - name: Copy files to build directory
        shell: pwsh
        run: |
          Copy-Item "*.ps1" -Destination "build/" -ErrorAction SilentlyContinue
          Copy-Item "*.json" -Destination "build/" -ErrorAction SilentlyContinue
          Copy-Item "*.md" -Destination "build/" -ErrorAction SilentlyContinue
          if (Test-Path "LICENSE") { Copy-Item "LICENSE" -Destination "build/" }
          Get-ChildItem -Path "build/"
          
      - name: Build executables
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          
          # Build Chocolatey GUI Installer (includes ChocolateyManager dependency)
          if (Test-Path "Chocolatey-GUI-Installer.ps1") {
            Write-Host "Building Chocolatey-GUI-Installer.exe..."
            
            # Ensure ChocolateyManager dependency is available
            if (Test-Path "ChocolateyManager.ps1") {
              Copy-Item "ChocolateyManager.ps1" -Destination "build/" -ErrorAction SilentlyContinue
              Write-Host "  Copied dependency: ChocolateyManager.ps1"
            }
            
            $ps2exeParams = @{
              inputFile = "Chocolatey-GUI-Installer.ps1"
              outputFile = "build/Chocolatey-GUI-Installer.exe"
              title = "Chocolatey GUI Installer"
              description = "ä¸»è¦ GUI å®‰è£ç¨‹å¼ (åŒ…å« ChocolateyManager ä¾è³´)"
              company = "OpenSource"
              product = "Chocolatey GUI Installer"
              copyright = "Copyright (c) $((Get-Date).Year)"
              version = "1.0.0.0"
              requireAdmin = $true
              STA = $true
              supportOS = $true
              longPaths = $true
            }
            Invoke-ps2exe @ps2exeParams
          }
          
          # Build Update-PackageConfig (standalone tool)
          if (Test-Path "Update-PackageConfig.ps1") {
            Write-Host "Building Update-PackageConfig.exe..."
            $ps2exeParams = @{
              inputFile = "Update-PackageConfig.ps1"
              outputFile = "build/Update-PackageConfig.exe"
              title = "Package Config Updater"
              description = "ç¨ç«‹çš„é…ç½®æ›´æ–°å·¥å…·"
              company = "OpenSource"
              product = "Package Config Updater"
              copyright = "Copyright (c) $((Get-Date).Year)"
              version = "1.0.0.0"
              STA = $true
              supportOS = $true
              longPaths = $true
            }
            Invoke-ps2exe @ps2exeParams
          }
          
          Write-Host "Build completed. Executables created:"
          Get-ChildItem -Path "build/" -Filter "*.exe" | ForEach-Object { 
            $size = [math]::Round($_.Length / 1KB, 1)
            Write-Host "  $($_.Name) - $size KB" 
          }
          
      - name: Prepare release packages
        shell: pwsh
        run: |
          # Copy files for scripts-only package
          Copy-Item "*.ps1" -Destination "scripts-only/" -ErrorAction SilentlyContinue
          Copy-Item "*.json" -Destination "scripts-only/" -ErrorAction SilentlyContinue
          Copy-Item "*.md" -Destination "scripts-only/" -ErrorAction SilentlyContinue
          if (Test-Path "LICENSE") { Copy-Item "LICENSE" -Destination "scripts-only/" }
          
          # Copy files for executables-only package
          Copy-Item "build/*.exe" -Destination "executables-only/" -ErrorAction SilentlyContinue
          # Copy ChocolateyManager.ps1 dependency for main installer
          Copy-Item "build/ChocolateyManager.ps1" -Destination "executables-only/" -ErrorAction SilentlyContinue
          Copy-Item "*.json" -Destination "executables-only/" -ErrorAction SilentlyContinue
          Copy-Item "README.md" -Destination "executables-only/" -ErrorAction SilentlyContinue
          Copy-Item "ä½¿ç”¨èªªæ˜Ž.md" -Destination "executables-only/" -ErrorAction SilentlyContinue
          
          # Create zip files
          Compress-Archive -Path "build/*" -DestinationPath "chocolatey-gui-installer-complete.zip" -Force
          Compress-Archive -Path "scripts-only/*" -DestinationPath "chocolatey-gui-installer-scripts.zip" -Force  
          Compress-Archive -Path "executables-only/*" -DestinationPath "chocolatey-gui-installer-executables.zip" -Force
          
          Write-Host "Release packages created:"
          Get-ChildItem -Path "." -Filter "*.zip" | ForEach-Object { 
            Write-Host "  $($_.Name) ($([math]::Round($_.Length/1MB, 2)) MB)" 
          }
          
      - name: Get release tag
        id: get_tag
        shell: pwsh
        run: |
          if ("${{ github.event.inputs.release_tag }}" -ne "") {
            $tag = "${{ github.event.inputs.release_tag }}"
          } else {
            $tag = "${{ github.ref_name }}"
          }
          echo "tag=$tag" >> $env:GITHUB_OUTPUT
          Write-Host "Release tag: $tag"
          
      - name: Generate release notes
        id: release_notes
        shell: pwsh
        run: |
          $version = "${{ steps.get_tag.outputs.tag }}"
          $releaseNotes = @"
          # Chocolatey GUI Installer $version
          
          ## ðŸ“¦ ä¸‹è¼‰æª”æ¡ˆ
          
          ### ðŸ”§ å®Œæ•´å¥—ä»¶ - chocolatey-gui-installer-complete.zip
          åŒ…å«æ‰€æœ‰ PowerShell è…³æœ¬ã€ç·¨è­¯å¾Œçš„åŸ·è¡Œæª”å’Œèªªæ˜Žæ–‡ä»¶
          
          ### ðŸ“ PowerShell è…³æœ¬å¥—ä»¶ - chocolatey-gui-installer-scripts.zip
          - **Chocolatey-GUI-Installer.ps1** - ä¸»è¦å®‰è£ç¨‹å¼ (éœ€ç®¡ç†å“¡æ¬Šé™)
          - **ChocolateyManager.ps1** - å¥—ä»¶ç®¡ç†å™¨ä¾è³´æª”æ¡ˆ
          - **Update-PackageConfig.ps1** - é…ç½®æ›´æ–°å·¥å…·
          - **packages-config.json** - å¥—ä»¶é…ç½®æª”
          - èªªæ˜Žæ–‡ä»¶
          
          ### âš¡ åŸ·è¡Œæª”å¥—ä»¶ - chocolatey-gui-installer-executables.zip  
          - **Chocolatey-GUI-Installer.exe** - ä¸»è¦å®‰è£ç¨‹å¼ (éœ€ç®¡ç†å“¡æ¬Šé™ï¼ŒåŒ…å«å¥—ä»¶ç®¡ç†åŠŸèƒ½)
          - **ChocolateyManager.ps1** - ä¾è³´æª”æ¡ˆ (GUI å®‰è£ç¨‹å¼éœ€è¦)
          - **Update-PackageConfig.exe** - é…ç½®æ›´æ–°å·¥å…·
          - é…ç½®æª”å’Œèªªæ˜Žæ–‡ä»¶
          
          ## ðŸš€ ä½¿ç”¨æ–¹å¼
          
          ### PowerShell è…³æœ¬ç‰ˆæœ¬
          1. ä¸‹è¼‰ä¸¦è§£å£“ç¸® ``chocolatey-gui-installer-scripts.zip``
          2. å³éµé»žé¸ PowerShellï¼Œé¸æ“‡ã€Œä»¥ç³»çµ±ç®¡ç†å“¡èº«åˆ†åŸ·è¡Œã€
          3. åˆ‡æ›åˆ°è§£å£“ç¸®çš„è³‡æ–™å¤¾
          4. åŸ·è¡Œï¼š``.\Chocolatey-GUI-Installer.ps1``
          
          ### åŸ·è¡Œæª”ç‰ˆæœ¬ (æŽ¨è–¦)
          1. ä¸‹è¼‰ä¸¦è§£å£“ç¸® ``chocolatey-gui-installer-executables.zip``
          2. å³éµé»žé¸ ``Chocolatey-GUI-Installer.exe``
          3. é¸æ“‡ã€Œä»¥ç³»çµ±ç®¡ç†å“¡èº«åˆ†åŸ·è¡Œã€
          
          ## âœ… ç³»çµ±éœ€æ±‚
          - Windows 10 æˆ–æ›´æ–°ç‰ˆæœ¬
          - ç®¡ç†å“¡æ¬Šé™ (å®‰è£è»Ÿé«”æ™‚å¿…éœ€)
          - ç¶²éš›ç¶²è·¯é€£ç·š
          
          ## ðŸŽ¯ ä¸»è¦åŠŸèƒ½
          - âœ¨ å‹å–„çš„åœ–å½¢åŒ–ä»‹é¢
          - ðŸ”§ ä¸€éµå®‰è£ Chocolatey
          - ðŸ“¦ æ‰¹æ¬¡å®‰è£å¸¸ç”¨è»Ÿé«”å¥—ä»¶
          - âš™ï¸ å¥—ä»¶é…ç½®ç®¡ç†
          - ðŸŒ ç¹é«”ä¸­æ–‡ä»‹é¢
          "@
          
          $releaseNotes | Out-File -FilePath "release_notes.md" -Encoding utf8NoBOM
          echo "notes_file=release_notes.md" >> $env:GITHUB_OUTPUT
          
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_tag.outputs.tag }}
          name: "Chocolatey GUI Installer ${{ steps.get_tag.outputs.tag }}"
          body_path: release_notes.md
          prerelease: ${{ github.event.inputs.pre_release || false }}
          files: |
            chocolatey-gui-installer-complete.zip
            chocolatey-gui-installer-scripts.zip
            chocolatey-gui-installer-executables.zip
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: chocolatey-gui-installer-${{ steps.get_tag.outputs.tag }}
          path: |
            build/
            *.zip
          retention-days: 90